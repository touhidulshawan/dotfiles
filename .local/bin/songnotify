#!/bin/bash

TMPDIR="/tmp/albumart"
mkdir -p "$TMPDIR"

last_trackid=""

while true; do
    trackid=$(playerctl metadata --format '{{mpris:trackid}}')
    title=$(playerctl metadata --format '{{title}}')
    artist=$(playerctl metadata --format '{{artist}}')
    arturl=$(playerctl metadata --format '{{mpris:artUrl}}')

    if [ "$trackid" != "$last_trackid" ]; then
        last_trackid="$trackid"

        # handle art
        iconpath=""
        if [[ "$arturl" == file://* ]]; then
            iconpath="${arturl#file://}"
        elif [[ "$arturl" == http* ]]; then
            filename="$TMPDIR/$(basename "$arturl")"
            curl -s -L "$arturl" -o "$filename"
            iconpath="$filename"
        fi

        # send notification
        if [ -n "$iconpath" ]; then
            notify-send -i "$iconpath" "$title" "$artist"
        else
            notify-send "$title" "$artist"
        fi
    fi

    # check every 1 second
    sleep 1
done
